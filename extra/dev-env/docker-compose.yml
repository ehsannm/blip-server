version: '2'
services:

  # API Edge Server
  edge:
    restart: always
    image: registry.ronaksoftware.com/river/server/server-api-edge:dev
    expose:
      - 8080
      - 6060
    ports:
      - 6061:6060
    cpuset: "0,1"
    environment:
      - RIVER_BUNDLE_ID=EDGE
      - RIVER_INSTANCE_ID=001
      - RIVER_NATS_URL=nats://nats:4222
      - RIVER_DB_CASSANDRA_DSN=db
      - RIVER_DB_CASSANDRA_USER=cassandra
      - RIVER_DB_CASSANDRA_PASS=cassandra
      - RIVER_CACHE_REDIS_PERM_DSN=cache:6379
      - RIVER_CACHE_REDIS_PERM_PASS=ehsan2374
      - RIVER_CACHE_REDIS_TEMP_DSN=cache:6379
      - RIVER_CACHE_REDIS_TEMP_PASS=ehsan2374
      - RIVER_ADP_MESSAGE_URL=https://ws.adpdigital.com/url/send
      - RIVER_ADP_USERNAME=ronak
      - RIVER_ADP_PASSWORD=E2e2374k19743
      - RIVER_TEST_MODE=true
      - RIVER_LOG_LEVEL=1
      - RIVER_DB_CASSANDRA_CONNECTIONS=20
      - RIVER_STORAGE_CLUSTER_ID=1
      - RIVER_STORAGE_TEMP_PATH=/ronak/storage
      - RIVER_MONGO_DSN=mongo-files:27001
      - RIVER_SALT_MANAGER_SAFETY_MARGIN=5000
      - RIVER_SALT_MANAGER_RETRIEVE_INTERVAL=5000000000

    networks:
      - river

  # Engine-Chat Server
  engine:
    restart: always
    image: registry.ronaksoftware.com/river/server/server-engine-chat:dev
    expose:
      - 6060
    ports:
      - 6060:6060
    cpuset: "2,3"
    environment:
      - RIVER_BUNDLE_ID=ENGINE-CHAT
      - RIVER_INSTANCE_ID=001
      - RIVER_NATS_URL=nats://nats:4222
      - RIVER_DB_CASSANDRA_DSN=db
      - RIVER_DB_CASSANDRA_USER=cassandra
      - RIVER_DB_CASSANDRA_PASS=cassandra
      - RIVER_CACHE_REDIS_PERM_DSN=cache:6379
      - RIVER_CACHE_REDIS_PERM_PASS=ehsan2374
      - RIVER_CACHE_REDIS_TEMP_DSN=cache:6379
      - RIVER_CACHE_REDIS_TEMP_PASS=ehsan2374
      - RIVER_LOG_LEVEL=1
      - RIVER_ADP_MESSAGE_URL=https://ws.adpdigital.com/url/send
      - RIVER_NOTIFICATION_SERVER=http://notification:8080
      - RIVER_ADP_USERNAME=ronak
      - RIVER_ADP_PASSWORD=E2e2374k19743
      - RIVER_TEST_MODE=true
      - RIVER_STORAGE_CLUSTER_ID=1
      - RIVER_STORAGE_TEMP_PATH=/ronak/storage
      - RIVER_MONGO_DSN=mongo-files:27001
      - RIVER_NUMBER_OF_EXECUTORS=10000
      - RIVER_AP_HOST=localhost
    volumes:
      - ./_hdd/engine:/ronak/storage
    networks:
      - river

  # API File Server
  file:
    restart: always
    image: registry.ronaksoftware.com/river/server/server-api-file:dev
    expose:
      - 8081
    cpuset: "8"
    environment:
      - RIVER_BUNDLE_ID=FILE
      - RIVER_INSTANCE_ID=001
      - RIVER_NATS_URL=nats://nats:4222
      - RIVER_DB_CASSANDRA_DSN=db
      - RIVER_DB_CASSANDRA_USER=cassandra
      - RIVER_DB_CASSANDRA_PASS=cassandra
      - RIVER_CACHE_REDIS_PERM_DSN=cache:6379
      - RIVER_CACHE_REDIS_PERM_PASS=ehsan2374
      - RIVER_CACHE_REDIS_TEMP_DSN=cache:6379
      - RIVER_CACHE_REDIS_TEMP_PASS=ehsan2374
      - RIVER_ADP_MESSAGE_URL=https://ws.adpdigital.com/url/send
      - RIVER_ADP_USERNAME=ronak
      - RIVER_ADP_PASSWORD=E2e2374k19743
      - RIVER_TEST_MODE=true
      - RIVER_LOG_LEVEL=1
      - RIVER_DB_CASSANDRA_CONNECTIONS=20
      - RIVER_STORAGE_CLUSTER_ID=1
      - RIVER_STORAGE_TEMP_PATH=/ronak/storage
      - RIVER_MONGO_DSN=mongo-files:27017
      - RIVER_SALT_MANAGER_SAFETY_MARGIN=5000
      - RIVER_SALT_MANAGER_RETRIEVE_INTERVAL=5000000000


    volumes:
      - ./_hdd/file:/ronak/storage
    networks:
      - river

  # API NOTIFICATION Server
  notification:
    restart: always
    image: registry.ronaksoftware.com/river/server/server-api-notification:dev
    expose:
      - 8080
    cpuset: "8"
    environment:
      - RIVER_MONGO_HOST=mongo-files:27017
      - RIVER_SERVER_ADDR=:80
      - RIVER_MONGO_TLS=false
      - RIVER_SCYLLA_HOST=db
      - RIVER_SCYLLA_USERNAME=cassandra
      - RIVER_SCYLLA_PASSWORD=cassandra
      - RIVER_BUNDLE_ID=NOTIFICATION
      - RIVER_INSTANCE_ID=001
      - RIVER_DB_CASSANDRA_DSN=db
      - RIVER_DB_CASSANDRA_USER=cassandra
      - RIVER_DB_CASSANDRA_PASS=cassandra
      - RIVER_REDIS_PERM_HOST=cache:6379
      - RIVER_REDIS_PERM_PASS=ehsan2374
      - RIVER_REDIS_TEMP_HOST=cache:6379
      - RIVER_REDIS_TEMP_PASS=ehsan2374
      - RIVER_TEST_MODE=true
      - RIVER_MAX_CONCURRENCY=3
      - RIVER_LOG_LEVEL=1
      - RIVER_APN_TOPIC=im.river.ios
    networks:
      - river

  cron:
    image: registry.ronaksoftware.com/river/server/server-cron:dev
    environment:
      - RIVER_CACHE_REDIS_PERM_DSN=cache:6379
      - RIVER_CACHE_REDIS_PERM_PASS="ehsan2374"
      - RIVER_CRON_SPEC_SALT_GEN=@hourly
    networks:
      - river

networks:
  river:
    external:
      name: river
  proxy:
    external:
      name: proxy